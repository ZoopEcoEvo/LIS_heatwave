---
title: "Seasonal Variation in Transgenerational Effects of Heatwaves in a Marine Copepod"
author: 'Intended for: Proceedings B?'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, fig.align= "center")
```

```{r, echo = F}
library(knitr)
local({
  if(knitr::is_latex_output()) {
    plot_default <- knit_hooks$get("plot")
    knit_hooks$set(plot = function(x, options) { 
      x <- c(plot_default(x, options), "\\vspace{13pt}" )
    })
  }
})

options(digits = 2)
```

```{r include = F, message = F, warning = F}
library(readxl)
library(ggplot2)
library(MASS)
library(minpack.lm)
library(dabestr)
library(knitr)
library(ggpubr)
library(tidyverse)
library(colorblindr)


st.err <- function(x, na.rm=FALSE) {
  if(na.rm==TRUE) x <- na.omit(x)
  sd(x)/sqrt(length(x))
}


#Survivorship Curves
surv_data = read_excel("~/Desktop/Lab_Projects/Heatwave/My_analysis/Surv_analysis.xlsx")
surv = as.data.frame(surv_data)
```

# General Outline     
1. Look at seasonal patterns in TPCs    

2. Look at effects of heatwaves on parents    

3. Look at effects of heatwaves on offspring    

4. Are there seasonal differences in the effects, and **how (if at all) are these related to the seasonal patterns in TPCs** (this is what's still missing)     

<br>    

# Main Findings  
### Field TPCs   
* TPCs are highly variable across seasons, but maintain a relatively fixed margin between field temperature and optimum temperature.      

### F0 Effects of Heatwaves    
* Short heatwaves had either no effect (June and November) or a positive effect (August) in the F0 individuals. Long heatwaves had a slight negative effect in June, and no effects in August or November.    

### F1 Effects of Heatwaves    
* Heatwaves generally decreased F1 body size.     
* Heatwaves had mixed effects on F1 RF that were not related to the effects on body size.   

\newpage  

# Introduction    
* Heatwaves are increasing in both frequency and intensity.     
* Summary of literature on effects of heat waves    
* Fixed vs. variable TPCs affect response to heat waves (& short section on sources of variation - genetic, plastic, etc.)    
* Transgenerational effects also need to be considered  

## Hypotheses
**Hypothesis 1**: TPCs of *Acartia tonsa* are not fixed, but rather seasonally variable.

**Hypothesis 2**: For variable TPCs, the effects of heat waves will depend on the seasonal timing and duration of the event.

# Methods
**Will need substantial input from other people to fill in the methods section.**

\newpage    
# Results 
## Seasonal Variation in TPCs  
```{r}
# #getting all parameter estimates
# month_pars = data.frame(matrix(ncol = 11, nrow = 0))
# colnames(month_pars) <- c("Month", "epr_a", "epr_b", "epr_c", "hs_a", "hs_b", "hs_c", "rf_a", "rf_b", "rf_c", "Coll_temp")
# mlist = unique(h1_epr$Month)
# for(i in 1:length(mlist)){
#   mdata = h1_epr[h1_epr$Month==mlist[i],]
#   #set initial conditions based on approximate values (sensitivity is low)
#   para = 50 #max height
#   parb = 25 #position of center
#   parc = 10 #width
#   est_epr = nlsLM(formula = EPR~a*exp(-0.5*((Temp-b)/c)^2), 
#                   data = mdata, start = list(a = para, b = parb, c = parc))
#   
#   est_hs = nlsLM(formula = HF_p~a*exp(-0.5*((Temp-b)/c)^2), 
#                  data = mdata, start = list(a = para, b = parb, c = parc))
#   
#   est_rf = nlsLM(formula = RF~a*exp(-0.5*((Temp-b)/c)^2), 
#                  data = mdata, start = list(a = para, b = parb, c = parc))
#   
#   coll = mdata$Coll_temp[1]
#   pars_epr = est_epr$m$getPars()
#   pars_hs = est_hs$m$getPars()
#   pars_rf = est_rf$m$getPars()
#   
#   month_pars[i,1] = as.character(mlist[i])
#   month_pars[i,11] = as.numeric(as.character(coll))
#   month_pars[i,2:4]= as.numeric(as.character(pars_epr))
#   month_pars[i,5:7]= as.numeric(as.character(pars_hs))
#   month_pars[i,8:10]= as.numeric(as.character(pars_rf))
# }
# 
# 
# month_pars$Month = factor(month_pars$Month, levels = c("July", "August", "September", "October", "November_1", "November_2"))
# 
# month_pars$coll_opt_diff = month_pars$rf_b - month_pars$Coll_temp

Hyp1_EPR <- read_excel("~/Desktop/Lab_Projects/Heatwave/My_analysis/Hyp1_EPR.xlsx")
h1_epr = as.data.frame(Hyp1_EPR)
h1_epr$HF_p = h1_epr$HF*100
h1_epr$Month = factor(h1_epr$Month, levels = c("July", "August", "September", "October", "November_1", "November_2"))

#getting all parameter estimates
month_pars = data.frame(matrix(ncol = 11, nrow = 0))
colnames(month_pars) <- c("Month", "epr_a", "epr_b", "epr_c", "hs_a", "hs_b", "hs_c", "rf_a", "rf_b", "rf_c", "Coll_temp")
mlist = unique(h1_epr$Month)
for(i in 1:length(mlist)){
  mdata = h1_epr[h1_epr$Month==mlist[i],]
  #set initial conditions based on approximate values (sensitivity is low)
  para = 50 #max height
  parb = 25 #position of center
  parc = 10 #width
  est_epr = nlsLM(formula = EPR~a*exp(-0.5*((Temp-b)/c)^2), 
                  data = mdata, start = list(a = para, b = parb, c = parc))
  
  est_hs = nlsLM(formula = HF_p~a*exp(-0.5*((Temp-b)/c)^2), 
                 data = mdata, start = list(a = para, b = parb, c = parc))
  
  est_rf = nlsLM(formula = RF~a*exp(-0.5*((Temp-b)/c)^2), 
                 data = mdata, start = list(a = para, b = parb, c = parc))
  
  coll = mdata$Coll_temp[1]
  pars_epr = est_epr$m$getPars()
  pars_hs = est_hs$m$getPars()
  pars_rf = est_rf$m$getPars()
  
  month_pars[i,1] = as.character(mlist[i])
  month_pars[i,11] = as.numeric(as.character(coll))
  month_pars[i,2:4]= as.numeric(as.character(pars_epr))
  month_pars[i,5:7]= as.numeric(as.character(pars_hs))
  month_pars[i,8:10]= as.numeric(as.character(pars_rf))
}


month_pars$Month = factor(month_pars$Month, levels = c("July", "August", "September", "October", "November_1", "November_2"))

month_pars$coll_opt_diff = month_pars$rf_b - month_pars$Coll_temp
```

There was abundant variation in TPCs for Egg Production Rate (EPR), hatching success (HS), and realized fecundity (RF) for copepods collected throughout the year. EPR TPCs had higher optimum temperatures and maximum values in warmer months (July, August, and September) than in cooler months (October and November). Peaks were generally less distinct for HS than EPR, but cooler months had slightly warmer optimum temperatures than those from warmer months. However, hatching success was generally higher in warmer months than cooler months, regardless of temperature. When combined, the variation in optimum temperature and maximum value for EPR and HS curves yielded RF curves that were highly variable. Collections from warmer months generally had slightly higher optimum temperatures as well as higher maximum fecundity. Thermal survivorship curves also varied significantly between collections.  
<br>  
```{r Seasonal_TPCs, fig.height=6}
epr_plot = ggplot(month_pars, aes(x = epr_b, y = epr_a, colour = Month)) + geom_point(data = h1_epr, aes(x = Temp, y = EPR, colour = Month, alpha = 0.01), position = position_jitter(width = 0.5, height = 0), show.legend = F) +
  theme_pubr(base_size = 12) + xlab("Temperature") + ylab("Egg Production \n(per female)") +
  scale_color_brewer(type = "div", palette = 5) + guides(color=guide_legend(override.aes=list(fill=NA))) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[1],], mapping = aes(x = Temp, y = EPR, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$epr_b[1])/month_pars$epr_c[1])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[2],], mapping = aes(x = Temp, y = EPR, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$epr_b[2])/month_pars$epr_c[2])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[3],], mapping = aes(x = Temp, y = EPR, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$epr_b[3])/month_pars$epr_c[3])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[4],], mapping = aes(x = Temp, y = EPR, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$epr_b[4])/month_pars$epr_c[4])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[5],], mapping = aes(x = Temp, y = EPR, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$epr_b[5])/month_pars$epr_c[5])^2), se = T, size = 1) + 
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[6],], mapping = aes(x = Temp, y = EPR, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$epr_b[6])/month_pars$epr_c[6])^2), se = T, size = 1)

hs_plot = ggplot(month_pars, aes(x = hs_b, y = hs_a, colour = Month)) + geom_point(data = h1_epr, aes(x = Temp, y = HF_p, colour = Month, alpha = 0.01), position = position_jitter(width = 0.5, height = 0), show.legend = F) +
  theme_pubr(base_size = 12) + xlab("Temperature") + ylab("Hatching Success (%)") +
  scale_color_brewer(type = "div", palette = 5) + guides(color=guide_legend(override.aes=list(fill=NA))) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[1],], mapping = aes(x = Temp, y = HF_p, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$hs_b[1])/month_pars$hs_c[1])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[2],], mapping = aes(x = Temp, y = HF_p, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$hs_b[2])/month_pars$hs_c[2])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[3],], mapping = aes(x = Temp, y = HF_p, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$hs_b[3])/month_pars$hs_c[3])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[4],], mapping = aes(x = Temp, y = HF_p, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$hs_b[4])/month_pars$hs_c[4])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[5],], mapping = aes(x = Temp, y = HF_p, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$hs_b[5])/month_pars$hs_c[5])^2), se = T, size = 1) + 
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[6],], mapping = aes(x = Temp, y = HF_p, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$hs_b[6])/month_pars$hs_c[6])^2), se = T, size = 1)

rf_plot = ggplot(month_pars, aes(x = rf_b, y = rf_a, colour = Month)) + geom_point(data = h1_epr, aes(x = Temp, y = RF, colour = Month, alpha = 0.01), position = position_jitter(width = 0.5, height = 0), show.legend = F) +
  theme_pubr(base_size = 12) + xlab("Temperature") + ylab("Relative Fecundity \n(per female)") +
  scale_color_brewer(type = "div", palette = 5) + guides(color=guide_legend(override.aes=list(fill=NA))) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[1],], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$rf_b[1])/month_pars$rf_c[1])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[2],], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$rf_b[2])/month_pars$rf_c[2])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[3],], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$rf_b[3])/month_pars$rf_c[3])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[4],], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$rf_b[4])/month_pars$rf_c[4])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[5],], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$rf_b[5])/month_pars$rf_c[5])^2), se = T, size = 1) + 
  geom_smooth(data = h1_epr[h1_epr$Month==month_pars$Month[6],], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars$rf_b[6])/month_pars$rf_c[6])^2), se = T, size = 1)

#### Estimating LD50 ####
#Pull out a list of all pops contained in the data set
month_list = unique(surv$Month)

#Set up an empty data frame to record LD50 values in 
tolerance = data.frame(matrix(ncol = 5, nrow = 0))
colnames(tolerance) <- c("Month", "Coll_temp", "LD50", "SE", "Margin")

count = 0 
#Pull out the data for just one population
for(i in 1:length(month_list)){
  month = month_list[i]
  mdata = surv[surv$Month == month,]
  
  m.model = glm(Surv ~ Temp, data=mdata, family=binomial(link = "logit"))
  LD50 = dose.p(m.model, p = 0.5)
  LD = as.numeric(LD50[1])
  SE = attr(LD50, "SE")
  margin = LD - mdata$Coll_temp[1]
  
  #Increase count to set to appropriate row number and record relevant data 
  tolerance[i, 1] = month
  tolerance[i, 2] = mdata$Coll_temp[1]
  tolerance[i, 3] = LD
  tolerance[i, 4] = as.numeric(SE)
  tolerance[i, 5] = margin
}

tolerance$Month = factor(tolerance$Month, levels = c("July", "August", "September", "October", "November_1", "November_2"))
surv$Month = factor(surv$Month, levels = c("July", "August", "September", "October", "November_1", "November_2"))

tpc = ggplot(surv, aes(x=Temp, y=Surv, colour=Month)) + geom_point(shape=1, size=1, position=position_jitter(width=0.1, height=0.03)) +
  xlab("Stress Temperature")+
  ylab("Survivorship")+
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se=T, size = 1) +
  scale_y_continuous(breaks = c(0,1)) + theme_pubr(base_size = 12) +
  scale_color_brewer(type = "div", palette = 5, 
                     breaks = c("July", "August", "September", "October", "November_1", "November_2"))

a = ggplot() + theme_pubclean()
ggarrange(epr_plot, a, hs_plot, rf_plot, a, tpc, ncol = 3, nrow = 2, common.legend = T, legend = "bottom", widths = c(1,.1,1))
```
<br>  
<br>  
Optimum temperature for RF tracked collection temperature, maintaining a fairly large "safety margin" (collection temperature never exceeded optimum temperatures). The one outlier was the second November collection, which was collected at 11 degrees C. This is below the threshold for resting egg production for A. tonsa. The extremely high estimated RF optimum temperature may reflect that the eggs produced were resting eggs. 

```{r warning = F, message = F, fig.width=7, fig.height=3.5}
opt_coll = ggplot(month_pars, aes(x = Coll_temp, y = rf_b)) + 
  geom_smooth(data = month_pars[month_pars$Month != "November_2",], method = "lm", colour = "grey30") + 
  geom_point(size = 3) + 
  theme_pubr() + ylab("RF Optimum Temperature (deg C)") + xlab("Collection Temperature (deg c)") + 
  geom_vline(xintercept = 12.5, linetype = "dashed")

opt_diff = ggplot(month_pars, aes(x = Coll_temp, y = coll_opt_diff)) +
  geom_smooth(data = month_pars[month_pars$Month != "November_2",], method = "lm", colour = "grey30") + 
  geom_point(size = 3) + 
  theme_pubr() + ylab("Optimum - Collection Temperature (deg C)") + xlab("Collection Temperature (deg c)") + 
  scale_color_brewer(type = "div", palette = 5) + geom_vline(xintercept = 12.5, linetype = "dashed")


a = ggplot() + theme_void()

ggarrange(opt_coll, a, opt_diff, ncol = 3, widths = c(1,0.1,1.2))
```

These results suggest that the field population has a variable TPC for multiple traits. Field temperatures appear to always be below the optimum temperature, indicating that heat waves should have a beneficial effect by moving the population towards its optimum temperature. 

\newpage  
## Transgenerational Effects of Simulated Heatwave  
### F0 Individuals  

```{r}
F0_EPR <- read_excel("~/Desktop/Lab_Projects/Heatwave/My_analysis/F0_EPR.xlsx")
F0_epr = as.data.frame(F0_EPR)

#RF Reacton norm
for(i in 1:length(F0_epr[,1])){
  if(F0_epr$Treatment[i] == "Heatwave"){
    F0_epr$Female[i] = F0_epr$Female[i] + 40
  }
}

exp_design = unique(F0_epr[,1:3])
```

The "transgenerational" component of this project examined the effects of heatwaves across several generations, starting with the field collected F0. We examined the effects of heatwave duration (coded as "Day"), treatment, and collection month on EPR, HS, and RF. We will focus the analysis on RF. The ANOVA indicated no significant overall effect of heatwaves on RF (p-value = 0.38). There was, however, a significant interaction between treatment and collection month (p-value = 0.01), indicating different effects of heatwaves across months. The different trial durations and collection months were also significantly different, with significant interaction terms as well.  
<br>  
```{r results= "asis"}
print("Realized Fecundity")
F0_rf.model = lm(data = F0_epr, Hatched ~ Day * Treatment * Month)
kable(anova(F0_rf.model, test = "Chisq"))
```

Shown below are comparisons between the control and heat wave treatments. The different duration are shown in separate plots. The effect of trial duration itself is shown in the next figure. These plots are variants of Gardner-Altman estimation plots. These plots follow best practices for the visualization of differences between groups. The top half of each figure shows the underlying data points in a swarm plot. To the right of each each swarm is the mean and standard deviation of the group, represented using a gapped bar (gap = mean value). Below the raw data, the effect size and 95% confidence intervals are shown, which were obtained using non-parametric bootstrap resampling. 
<br>  

Remember, the control and heatwave temperatures varied across months.
```{r}
exp_design$Month = factor(exp_design$Month, levels = c("June", "August", "November"))
exp_design = exp_design[order(exp_design$Month),]
row.names(exp_design) = NULL

kable(exp_design)
```

The estimated optimum temperatures for RF from the field TPCs are shown below as well.
```{r}
month_pars %>% 
  select(., Month, "RF Optimum" = rf_b) %>% 
  kable()
```


```{r fig.height=8, fig.width=8}
F0_epr$Duration = F0_epr$Day
F0_epr$Duration[F0_epr$Day == "1_to_3"] = "Short"
F0_epr$Duration[F0_epr$Day == "5_to_7"] = "Long"
F0_epr$Duration = factor(F0_epr$Duration, levels = c("Short","Long"))
F0_epr$Month[F0_epr$Month == "November"] = "Nov"

F0_epr$treat_ID = paste(F0_epr$Month, F0_epr$Treatment, sep = "_")

RF_short = dabest(F0_epr[F0_epr$Day == "1_to_3",], treat_ID, Hatched, id.column = Female, paired = F, 
                  idx = list(c("June_Control", "June_Heatwave"),
                             c("August_Control", "August_Heatwave"),
                             c("Nov_Control", "Nov_Heatwave")))

RF_long = dabest(F0_epr[F0_epr$Day == "5_to_7",], treat_ID, Hatched, id.column = Female, paired = F, 
                 idx = list(c("June_Control", "June_Heatwave"),
                            c("August_Control", "August_Heatwave"),
                            c("Nov_Control", "Nov_Heatwave")))

param_list = list()
param_list[["colour"]] = "black"
param_list[["width"]] = 0.2

RF_short_db = plot(RF_short, 
                   axes.title.fontsize = 10,
                   tick.fontsize = 10,
                   effsize.markersize = 3,
                   swarmplot.params = param_list,
                   rawplot.ylabel = "Realized Fecundity",
                   theme = ggpubr::theme_pubr())

RF_long_db = plot(RF_long, 
                  axes.title.fontsize = 10,
                  tick.fontsize = 10,
                  effsize.markersize = 3,
                  swarmplot.params = param_list,
                  rawplot.ylabel = "Realized Fecundity",
                  theme = ggpubr::theme_pubr())

b1 = ggplot() + theme_pubclean() + ggtitle("          Short Heat Waves")
b2 = ggplot() + theme_pubclean() + ggtitle("          Long Heat Waves")
ggarrange(b1, RF_short_db, b2, RF_long_db, ncol = 1, nrow = 4, heights = c(0.1, 1, 0.1, 1))
```

There was also substantial variation within treatments over time. Shown below are similar plots following individual female responses over time within each treatment. Here, the Gardner-Altman plot has been modified to show the repeated measures for each female using a Tufte slopegraph instead of a swarmplot. RF was generally lower in Days 5 to 7 than during days 1 to 3, regardless of treatment (heat wave vs. control), although not for all collections (RF increased in the longer trials in November) - However, note the y-axis scale for the female responses relative to those from the other months. A similar decrease in both control and heatwave treatments might suggest effects of aging on female reproductive output. A stronger decrease in the heatwave treatment than in the control, might indicate cumulative effects of the increased temperature. An increase in RF over time might be expected from the effects of beneficial acclimation.    

\newpage  

```{r fig.height=10, fig.width=6}
fem_pres = table(factor(F0_epr$Female), F0_epr$Day, F0_epr$Month)
june_female = fem_pres[,1,2] == fem_pres[,2,2]
June_F0 = F0_epr[F0_epr$Month == "June",]
June_F0$treat_ID = paste(June_F0$Duration, June_F0$Treatment, sep = "_")
june_RF = dabest(June_F0, treat_ID, Hatched, paired = T, id.column = Female, 
                 idx = list(c("Short_Control", "Long_Control"),
                            c("Short_Heatwave", "Long_Heatwave")))

june_RF_db = plot(june_RF, 
                  axes.title.fontsize = 10,
                  tick.fontsize = 10,
                  effsize.markersize = 3,
                  effsize.ylim = c(-120, 15),
                  rawplot.ylabel = "Realized Fecundity",
                  theme = ggpubr::theme_pubr())


aug_female = fem_pres[,1,1] == fem_pres[,2,1]
aug_missing = unname(which(aug_female == F))
August_F0 = F0_epr[F0_epr$Month == "August",]
August_F0$treat_ID = paste(August_F0$Duration, August_F0$Treatment, sep = "_")
aug_missing_pos = which(August_F0$Female %in% aug_missing)
aug_RF = dabest(August_F0[-aug_missing_pos,], treat_ID, Hatched, paired = T, id.column = Female, 
                idx = list(c("Short_Control", "Long_Control"),
                           c("Short_Heatwave", "Long_Heatwave")))

aug_RF_db = plot(aug_RF, 
                 axes.title.fontsize = 10,
                 tick.fontsize = 10,
                 effsize.markersize = 3,
                 effsize.ylim = c(-120, 15),
                 rawplot.ylabel = "Realized Fecundity",
                 theme = ggpubr::theme_pubr())


nov_female = fem_pres[,1,3] == fem_pres[,2,3]
nov_missing = unname(which(nov_female == F))
November_F0 = F0_epr[F0_epr$Month == "Nov",]
November_F0$treat_ID = paste(November_F0$Duration, November_F0$Treatment, sep = "_")
nov_missing_pos = which(November_F0$Female %in% nov_missing)
nov_RF = dabest(November_F0[-nov_missing_pos,], treat_ID, Hatched, paired = T, id.column = Female, 
                idx = list(c("Short_Control", "Long_Control"),
                           c("Short_Heatwave", "Long_Heatwave")))

nov_RF_db = plot(nov_RF, 
                 axes.title.fontsize = 10,
                 tick.fontsize = 10,
                 effsize.markersize = 3,
                 effsize.ylim = c(-120, 15),
                 rawplot.ylabel = "Realized Fecundity",
                 theme = ggpubr::theme_pubr())

b1 = ggplot() + theme_pubclean() + ggtitle("          June Copepods")
b2 = ggplot() + theme_pubclean() + ggtitle("          August Copepods")
b3 = ggplot() + theme_pubclean() + ggtitle("          November Copepods")
ggarrange(b1, june_RF_db, b2, aug_RF_db, b3, nov_RF_db, ncol = 1, nrow = 6, heights = c(0.1, 1, 0.1, 1, 0.1, 1))
```

\newpage

```{r}
epr_comp = data.frame()
m_list = unique(F0_epr$Month)
for(i in 1:length(m_list)){
  m_data = F0_epr[F0_epr$Month == m_list[i],]
  t_list = unique(m_data$Treatment)
  for(j in 1:length(t_list)){
    t_data = m_data[m_data$Treatment == t_list[j],]
    e = t_data[t_data$Day == "1_to_3",]
    late_unmatch = t_data[t_data$Day == "5_to_7",]
    for(k in 1:length(e$Female)){
      early = e[k,]
      f = early$Female
      match = late_unmatch[late_unmatch$Female == f,]
      
      if(length(match$Month == 1)){
        bound = cbind(early$Month, early$Treatment, early$Temperature, early$Female, early$Hatched, early$Unhatched, early$Total, early$Success, match$Hatched, match$Unhatched, match$Total, match$Success)
        epr_comp = rbind(epr_comp, bound)
      }else{
        bound = cbind(early$Month, early$Treatment, early$Temperature, early$Female, early$Hatched, early$Unhatched, early$Total, early$Success, 999, 999, 999, 999)
        epr_comp = rbind(epr_comp, bound)
      }
    }
  }
}

epr_comp = `colnames<-`(epr_comp, c("Month", "Treatment", "Temperature","Female","Hatched_1", "Unhatched_1","Total_1","Success_1","Hatched_5", "Unhatched_5","Total_5","Success_5"))
epr_comp[,3] = as.numeric(as.character(epr_comp[,3]))
epr_comp[,5] = as.numeric(as.character(epr_comp[,5]))
epr_comp[,6] = as.numeric(as.character(epr_comp[,6]))
epr_comp[,7] = as.numeric(as.character(epr_comp[,7]))
epr_comp[,8] = as.numeric(as.character(epr_comp[,8]))
epr_comp[,9] = as.numeric(as.character(epr_comp[,9]))
epr_comp[,10] = as.numeric(as.character(epr_comp[,10]))
epr_comp[,11] = as.numeric(as.character(epr_comp[,11]))
epr_comp[,12] = as.numeric(as.character(epr_comp[,12]))

epr_comp[epr_comp==999] = NA


```

### F1 Individuals 
We also examined the effects of parental exposure to heatwaves on offspring traits. Comparing between Control and Heatwave treatments now examines not the direct effects of increased temperature, but the indirect effect on offspring of parental exposure to heatwaves. 
<br>  
```{r F1_epr_data}
###Transgen Data
F1_EPR <- read_excel("~/Desktop/Lab_Projects/Heatwave/My_analysis/F1_EPR.xlsx")
F1_epr = as.data.frame(F1_EPR)
F1_epr$Month = factor(F1_epr$Month, levels = c("June", "August", "November"))

F1_epr$Duration = F1_epr$Day
F1_epr$Duration[F1_epr$Duration == "1_to_3"] = "Short"
F1_epr$Duration[F1_epr$Duration == "5_to_7"] = "Long"
F1_epr$Duration = factor(F1_epr$Duration, levels = c("Short","Long"))


F1_fbs <- read_excel("~/Desktop/Lab_Projects/Heatwave/My_analysis/F1_sizes.xlsx")
F1_fbs = as.data.frame(F1_fbs)
F1_fbs$Month = factor(F1_fbs$Month, levels = c("June", "August", "November"))

F1_fbs$Duration = F1_fbs$Day
F1_fbs$Duration[F1_fbs$Duration == "1_to_3"] = "Short"
F1_fbs$Duration[F1_fbs$Duration == "5_to_7"] = "Long"
F1_fbs$Duration = factor(F1_fbs$Duration, levels = c("Short","Long"))
```

**Body Size**  
Offspring body size generally decreased with developmental temperature. The exceptions to this were F1 offspring of parents that experienced a short simulated heatwave from the June collection, and the offspring from short duration trails of both conditions in November (only the offspring that developed at 17 degrees are shown for the short November heatwave group as either the heatwave or the control offspring did not mature at the other temperatures). Within a developmental temperature, the effects of parental heatwave exposure on offspring size were generally small, but decreases were observed at almost all temperatures in August. Long parental heatwave exposure in November also decreased F1 body sizes.  
<br>  

```{r fig.width=9, fig.height=11}
month_list = unique(F1_fbs$Month)
F1_fbs$off_ID = paste(F1_fbs$Parental_treatment, F1_fbs$Offspring_temp, sep = "@")

bs_effect_size = data.frame(matrix(nrow = 0, ncol = 0))

for(i in 1:length(month_list)){
  mdata = F1_fbs[F1_fbs$Month == month_list[i],]
  
  short_bs_data = mdata[mdata$Duration == "Short",]
  long_bs_data = mdata[mdata$Duration == "Long",]
  
  if(month_list[i] == "November"){
  short_bs_db = dabest(short_bs_data, off_ID, Size, 
                    idx = list(c("Control@17", "Heatwave@17")))
  }else{
    short_bs_db = dabest(short_bs_data, off_ID, Size, 
                    idx = list(c("Control@12",  "Heatwave@12"),
                               c("Control@17", "Heatwave@17"),
                               c("Control@22", "Heatwave@22")))
  }
  
  long_bs_db = dabest(long_bs_data, off_ID, Size, 
                   idx = list(c("Control@12",  "Heatwave@12"),
                               c("Control@17", "Heatwave@17"),
                               c("Control@22", "Heatwave@22")))
  
  short_results = short_bs_db$result %>% 
    select(., colnames(short_bs_db$result[-14]))
  long_results = long_bs_db$result%>% 
    select(., colnames(long_bs_db$result[-14]))
  
  short_results$duration = "short"
  long_results$duration = "long"
    
  short_results$month = as.character(month_list[i])
  long_results$month = as.character(month_list[i])
  
  bs_effect_size = bind_rows(bs_effect_size, short_results, long_results)
  
  param_list = list()
  param_list[["colour"]] = "black"
  param_list[["width"]] = 0.2
  
  #Rename variables in loop
  name_1 = paste(month_list[i], "bs", "short", sep = "_")
  assign(name_1, 
         plot(short_bs_db, 
              rawplot.ylim = c(0.75, 1.05),
              effsize.ylim = c(-0.15, 0.05),
              effsize.markersize = 2,
              axes.title.fontsize = 9,
              tick.fontsize = 6,
              swarmplot.params = param_list,
              rawplot.ylabel = "Body Size (mm)",
              theme = ggpubr::theme_pubr())
  )
  
  name_2 = paste(month_list[i], "bs", "long", sep = "_")
  assign(name_2, 
         plot(long_bs_db, 
              rawplot.ylim = c(0.75, 1.05),
              effsize.ylim = c(-0.15, 0.05),
              effsize.markersize = 2,
              axes.title.fontsize = 9,
              tick.fontsize = 6,
              swarmplot.params = param_list,
              rawplot.ylabel = "Body Size (mm)",
              theme = ggpubr::theme_pubr())
  )
}

a1 = ggplot() + theme_pubclean() + ggtitle("          June - Short Heatwave")
a2 = ggplot() + theme_pubclean() + ggtitle("          June - Long Heatwave")

b1 = ggplot() + theme_pubclean() + ggtitle("          August - Short Heatwave")
b2 = ggplot() + theme_pubclean() + ggtitle("          August - Long Heatwave")

c1 = ggplot() + theme_pubclean() + ggtitle("          November - Short Heatwave")
c2 = ggplot() + theme_pubclean() + ggtitle("          November - Long Heatwave")
ggarrange(a1, a2, June_bs_short, June_bs_long, b1, b2, August_bs_short, August_bs_long, c1, c2, November_bs_short, November_bs_long, ncol = 2, nrow = 6, heights = c(0.1, 1, 0.1, 1, 0.1, 1))
```

\newpage    
**Fecundity**  
The effects of parental heatwave exposure varied strongly between collections, heatwave duration, and offspring temperature. As a reminder, these represent carry-over effects of heat waves - differences observed here do not represent the direct effects of heat waves, but rather indirect effects of parental exposure to heat waves.  

In June, Short heatwaves increased RF relative to controls at intermediate offspring temperatures, while long heat waves decreased RF relative to controls.  

In August, short heat waves had very little effect on RF, while long heat waves generally decreased RF.  

In November, both long and short heatwaves had positive effects on RF at intermediate temperatures. Short heatwaves also increased RF at high offspring temperatures relative to the control.  
<br>  

```{r fig.width=9, fig.height=11}
month_list = unique(F1_epr$Month)
F1_epr$off_ID = paste(F1_epr$Parental_treatment, F1_epr$Offspring_temp, sep = "@")

rf_effect_size = data.frame(matrix(nrow = 0, ncol = 0))


for(i in 1:length(month_list)){
  mdata = F1_epr[F1_epr$Month == month_list[i],]
  
  short_data = mdata[mdata$Duration == "Short",]
  long_data = mdata[mdata$Duration == "Long",]
  
  
  short_db = dabest(short_data, off_ID, Hatched, 
                    idx = list(c("Control@12",  "Heatwave@12"),
                               c("Control@17", "Heatwave@17"),
                               c("Control@22", "Heatwave@22")))
  
  long_db = dabest(long_data, off_ID, Hatched, 
                   idx = list(c("Control@12",  "Heatwave@12"),
                               c("Control@17", "Heatwave@17"),
                               c("Control@22", "Heatwave@22")))
  
  short_results = short_db$result %>% 
    select(., colnames(short_db$result[-14]))
  long_results = long_db$result%>% 
    select(., colnames(long_db$result[-14]))
  
  short_results$duration = "short"
  long_results$duration = "long"
    
  short_results$month = as.character(month_list[i])
  long_results$month = as.character(month_list[i])
  
  rf_effect_size = bind_rows(rf_effect_size, short_results, long_results)
  
  
  param_list = list()
  param_list[["colour"]] = "black"
  param_list[["width"]] = 0.2
  
  #Rename variables in loop
  name_1 = paste(month_list[i], "short", sep = "_")
  assign(name_1, 
         plot(short_db, 
              rawplot.ylim = c(0, 250),
              effsize.ylim = c(-100, 100),
              effsize.markersize = 2,
              axes.title.fontsize = 9,
              tick.fontsize = 6,
              swarmplot.params = param_list,
              rawplot.ylabel = "Realized Fecundity",
              theme = ggpubr::theme_pubr())
  )
  
  name_2 = paste(month_list[i], "long", sep = "_")
  assign(name_2, 
         plot(long_db, 
              rawplot.ylim = c(0, 250),
              effsize.ylim = c(-100, 100),
              effsize.markersize = 2,
              axes.title.fontsize = 9,
              tick.fontsize = 6,
              swarmplot.params = param_list,
              rawplot.ylabel = "Realized Fecundity",
              theme = ggpubr::theme_pubr())
  )
}

a1 = ggplot() + theme_pubclean() + ggtitle("          June - Short Heatwave")
a2 = ggplot() + theme_pubclean() + ggtitle("          June - Long Heatwave")

b1 = ggplot() + theme_pubclean() + ggtitle("          August - Short Heatwave")
b2 = ggplot() + theme_pubclean() + ggtitle("          August - Long Heatwave")

c1 = ggplot() + theme_pubclean() + ggtitle("          November - Short Heatwave")
c2 = ggplot() + theme_pubclean() + ggtitle("          November - Long Heatwave")
ggarrange(a1, a2, June_short, June_long, b1, b2, August_short, August_long, c1, c2, November_short, November_long, ncol = 2, nrow = 6, 
          heights = c(0.1, 1, 0.1, 1, 0.1, 1))
```

\newpage    
The changes in RF are independent of changes in body size - The expectation is that RF should decrease as body size decreases due to the effects on EPR. Shown below are the estimated effect sizes the comparisons between control and heatwave F1 offspring. There is no negative significant relationship between the two effect sizes.    
<br>  

```{r}
#Changes in body size 
bs_effect_size$trait = "body_size"

#Changes in RF 
rf_effect_size$trait = "RF"

#Join together data frames 
effect_comp = inner_join(bs_effect_size, rf_effect_size, by = c("control_group", "test_group", "month", "duration"))
effect_comp$month = factor(effect_comp$month, levels = c("June", "August", "November"))
seasonal_cols = c("June" = "#E69F00", "August" = "#D55E00", "November" = "#0072B2")

ggplot(effect_comp, aes(x = difference.x, y = difference.y)) +
  geom_smooth(method = "lm", colour = "black") +
  geom_point(size = 3, aes(colour = month, shape = duration)) + theme_pubr() + 
  geom_errorbar(aes(colour = month,ymin = bca_ci_low.y, ymax = bca_ci_high.y)) + 
  geom_errorbarh(aes(colour = month,xmin = bca_ci_low.x, xmax = bca_ci_high.x)) + 
  theme(legend.position = "bottom") + 
  scale_colour_manual(values = seasonal_cols) + 
  geom_hline(yintercept = 0, colour = "grey50") + geom_vline(xintercept = 0,  colour = "grey50") + 
  ylab("Change in RF") + xlab("Change in Body Size") 

```

## General patterns...    
...are scare in this data. Parental exposure to heat waves generally decreased offspring body size, while both short and long heat waves  had mixed effects on offspring RF. Most of these effects were limited to the intermediate offspring temperature. The changes observed in F1 RF are not related to changes in body size. Extrapolating from the field TPC section to the trangenerational section is difficult because 1) the months / sampling times don't exactly match up, and 2) because the transgenerational experiments use temperatures that differ in their relative position to the seasonally variable optimum temperatures. With this in mind, one potential approach is illustrated on the following pages. 

\newpage      

Shown below are the estimated RF curves from the field data (Hypothesis 1). The July second November curves were used as approximations for the June and November experiments, respectively. The top row shows the control and heatwave temperatures (black lines) relative to the optimum temperature (colored, dashed line). The second row shows the optimum temperatures relative to the F1 developmental temperatures.   
<br>  

```{r}
exp_design_ill = exp_design
exp_design_ill$Month = as.character(exp_design_ill$Month)
exp_design_ill$Month = factor(exp_design_ill$Month, levels = c("June", "August", "November"))
seasonal_cols2 = c("June" = "#E69F00", "August" = "#D55E00", "November" = "#0072B2")

month_pars_exp = month_pars[month_pars$Month %in% c("July", "August", "November_2"),]
month_pars_exp$Month = as.character(month_pars_exp$Month)
month_pars_exp[which(month_pars_exp$Month == "July"),1] = "June"
month_pars_exp[which(month_pars_exp$Month == "November_2"),1] = "November"
month_pars_exp$Month = factor(month_pars_exp$Month, levels = c("June", "August", "November"))

h1_epr_exp = h1_epr[h1_epr$Month %in% c("July", "August", "November_2"),]
h1_epr_exp$Month = as.character(h1_epr_exp$Month)
h1_epr_exp[which(h1_epr_exp$Month == "July"),1] = "June"
h1_epr_exp[which(h1_epr_exp$Month == "November_2"),1] = "November"
h1_epr_exp$Month = factor(h1_epr_exp$Month, levels = c("June", "August", "November"))

par_temps = ggplot(month_pars_exp, aes(x = rf_b, y = rf_a, colour = Month)) + 
  theme_pubr(base_size = 12) + xlab("Temperature") + ylab("Relative Fecundity \n(per female)") +
  scale_color_brewer(type = "div", palette = 5) + 
  geom_smooth(data = h1_epr_exp[h1_epr_exp$Month=="June",], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars_exp$rf_b[1])/month_pars_exp$rf_c[1])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr_exp[h1_epr_exp$Month=="August",], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars_exp$rf_b[2])/month_pars_exp$rf_c[2])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr_exp[h1_epr_exp$Month=="November",], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars_exp$rf_b[3])/month_pars_exp$rf_c[3])^2), se = T, size = 1) + 
  coord_cartesian(ylim = c(0, 90)) + 
  facet_grid(.~ Month) + theme(legend.position = "none") + 
  geom_vline(data = month_pars_exp[month_pars_exp$Month %in% c("June", "August", "November"),], 
             aes(xintercept = rf_b, colour = Month), linetype = "dashed") + 
  geom_vline(data = exp_design_ill, aes(xintercept = Temperature)) + 
  scale_colour_manual(values = seasonal_cols2) 

off_temps = ggplot(month_pars_exp, aes(x = rf_b, y = rf_a, colour = Month)) + 
  theme_pubr(base_size = 12) + xlab("Temperature") + ylab("Relative Fecundity \n(per female)") +
  scale_color_brewer(type = "div", palette = 5) + 
  geom_smooth(data = h1_epr_exp[h1_epr_exp$Month=="June",], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars_exp$rf_b[1])/month_pars_exp$rf_c[1])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr_exp[h1_epr_exp$Month=="August",], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars_exp$rf_b[2])/month_pars_exp$rf_c[2])^2), se = T, size = 1) +
  geom_smooth(data = h1_epr_exp[h1_epr_exp$Month=="November",], mapping = aes(x = Temp, y = RF, colour = Month),
              method = "lm", formula = y ~ exp(-0.5 * ((x-month_pars_exp$rf_b[3])/month_pars_exp$rf_c[3])^2), se = T, size = 1) + 
  coord_cartesian(ylim = c(0, 90)) + 
  facet_grid(.~ Month) + theme(legend.position = "none") + 
  geom_vline(data = month_pars_exp[month_pars_exp$Month %in% c("June", "August", "November"),], 
             aes(xintercept = rf_b, colour = Month), linetype = "dashed") + 
  geom_vline(xintercept = c(12, 17, 22)) + 
  scale_colour_manual(values = seasonal_cols2) 

ggarrange(par_temps, off_temps, nrow = 2)
```

Based on these curves, we estimated the expected RF values for the F1. This is assuming no changes in the TPC. The difference between the actual RF values and the predicted values are shown below, along with those differences converted to percent differences (relative to predicted values). Each bar is labelled with the developmental temperature. 

```{r fig.height= 9, fig.width=5}
predictions = data.frame(matrix(nrow = 0, ncol = 0))
exp_temps = c(12, 17, 22)
month = month_pars_exp$Month

for(i in 1:3){
temp = exp_temps[i]
pred_vals = month_pars_exp$rf_a * exp(-0.5 * ((temp - month_pars_exp$rf_b)/month_pars_exp$rf_c)^2)
preds = data.frame(month, temp, pred_vals)
predictions = bind_rows(predictions, preds)
}

predictions = bind_rows(predictions, predictions, predictions, predictions)
predictions$treatment = rep(c("Heatwave", "Control"), each = 18)
predictions$duration = rep(c("Short", "Long"), each = 9)


exp_data = aggregate(data = F1_epr, Hatched ~ Parental_treatment + Offspring_temp + Duration + Month, FUN = mean)
colnames(exp_data) = c("treatment", "temp", "duration", "month", "hatched")

pred_comp = inner_join(predictions, exp_data, by = c("treatment", "temp", "duration", "month"))
pred_comp$difference = pred_comp$hatched - pred_comp$pred_vals
pred_comp$perc_diff = (pred_comp$hatched - pred_comp$pred_vals) / pred_comp$pred_vals

pred_comp$ID = paste(pred_comp$month, pred_comp$temp, pred_comp$treatment, pred_comp$duration, sep = "_")

pred_comp$duration = factor(pred_comp$duration, levels = c("Short", "Long"))

bckg_cols = data.frame(xstart = seq(from = 0, to = 2 *(100/3), 100/3),
                       xend = seq(from = 100/3, to = 3 *(100/3), 100/3), 
                       month)

abs_diff = ggplot(pred_comp, aes(x = month, y = difference, fill = month, group = ID)) + 
  geom_bar(stat = "identity", position="dodge2") + 
  scale_fill_manual(values = seasonal_cols2) + facet_grid(treatment~duration) + 
  theme_bw() + geom_hline(yintercept = 0) + ylab("RF Difference (Actual - Predicted)") + 
  geom_text(aes(label=temp), position = position_dodge(width=0.9), vjust=1.5, size = 2.5) + ylim(-40, 130) + 
  theme(legend.position = "none") + ggtitle("Difference in RF")

percent_diff = ggplot(pred_comp, aes(x = month, y = perc_diff, fill = month, group = ID)) + 
  geom_bar(stat = "identity", position="dodge2") + 
  scale_fill_manual(values = seasonal_cols2) + facet_grid(treatment~duration) + 
  theme_bw() + geom_hline(yintercept = 0) + ylab("% RF Difference (Actual - Predicted)") + 
  ylim(-2.5, 6) + geom_text(aes(label=temp), position = position_dodge(width=0.9), vjust=1.5, size = 2.5) + 
  theme(legend.position = "none") + ggtitle("Percent Difference in RF")


ggarrange(abs_diff, percent_diff, nrow = 2)
```


<!-- Shown below is a correlation matrix for the parameters estimated from the models for EPR and HS. RF was excluded as it's a product of the other two traits. Within traits, there is a strong positive correlation between EPR optima and the breadth of the TPC. The optimum temperature of the hatching success TPC was negatively correlated with both the optimum temperature and the maximum value, which were positively correlated with each other. Between traits, there is a strong negative correlation between optimum temperatures for egg production and hatching success, and a strong positive correlation between the maximum values attained in hatching success and egg production. -->
<!-- <br>   -->
<!-- ```{r parameter_cor, fig.width=7, fig.height=7} -->
<!-- parameters = month_pars[,2:10] -->
<!-- colnames(parameters) = c("epr_max", "epr_opt", "epr_breadth", "hs_max", "hs_opt", "hs_breadth", "rf_max", "rf_opt", "rf_breadth") -->
<!-- par_cors = cor(parameters) -->
<!-- corrplot::corrplot(par_cors, diag = F, type = "lower", tl.col = "grey30") -->
<!-- ``` -->
<!-- When we pull out just those two strong between trait correlations, we see two things: there's a mismatch between EPR and HS optimum temperatures for all months (except August), and that generally summer copepods both produce more eggs, and have more eggs that hatch, compared with the fall copepods.   -->
<!-- <br>   -->
<!-- ```{r} -->
<!-- par_opt = ggplot(month_pars, aes(y = hs_b, x = epr_b)) +  -->
<!--   geom_smooth(method = "lm", colour = "grey50")+  -->
<!--   geom_point(size = 5, aes(colour = Month)) + -->
<!--   theme_pubr(base_size = 15) + ylab("Hatching Success optimum") +  -->
<!--   xlab("Egg Production optimum") +  -->
<!--   scale_color_brewer(type = "div", palette = 5) -->

<!-- par_max = ggplot(month_pars, aes(x = epr_a, y = hs_a)) +  -->
<!--   geom_smooth(method = "lm", colour = "grey50")+  -->
<!--   geom_point(size = 5, aes(colour = Month)) + -->
<!--   theme_pubr(base_size = 15) + ylab("Hatching Success maximum") +  -->
<!--   xlab("Egg Production maximum") +  -->
<!--   scale_color_brewer(type = "div", palette = 5) -->

<!-- ggarrange(par_opt, a, par_max, ncol = 3, widths = c(1,0.1,1), common.legend = T, legend = "bottom") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- F1_fbs_mean = aggregate(F1_fbs$Size, na.action = na.omit, by = list(F1_fbs$Month, F1_fbs$Parental_temp, F1_fbs$Parental_treatment, F1_fbs$Offspring_temp, F1_fbs$Day), FUN= mean) -->
<!-- F1_fbs_mean = `colnames<-`(F1_fbs_mean, c("Month", "Parental_temp", "Parental_treatment", "Offspring_temp","Day", "Size")) -->

<!-- F1_fbs_se = aggregate(F1_fbs$Size, by = list(F1_fbs$Month, F1_fbs$Parental_temp, F1_fbs$Parental_treatment, F1_fbs$Offspring_temp, F1_fbs$Day), FUN= st.err) -->
<!-- F1_fbs_se = `colnames<-`(F1_fbs_se, c("Month", "Parental_temp", "Parental_treatment", "Offspring_temp","Day", "SE")) -->

<!-- F1_fbs_summarized = cbind(F1_fbs_mean, F1_fbs_se$SE) -->
<!-- F1_fbs_summarized$Month = factor(F1_fbs_summarized$Month, levels = c("June", "August", "November")) -->

<!-- F1_fbs_summarized$Duration = F1_fbs_summarized$Day -->
<!-- F1_fbs_summarized$Duration[F1_fbs_summarized$Duration == "1_to_3"] = "Short" -->
<!-- F1_fbs_summarized$Duration[F1_fbs_summarized$Duration == "5_to_7"] = "Long" -->
<!-- F1_fbs_summarized$Duration = factor(F1_fbs_summarized$Duration, levels = c("Short","Long")) -->


<!-- ggplot(F1_fbs_summarized, aes(x = Offspring_temp, y = Size, colour = as.factor(Parental_temp), group = Parental_treatment)) + -->
<!--   geom_errorbar(size=1, aes(ymin=(Size - F1_fbs_se$SE), ymax=(Size + F1_fbs_se$SE)), width=.5) + -->
<!--   geom_line(size = 1.5) + geom_point(size = 3) +  -->
<!--   theme_bw(base_size = 12) + facet_grid(Month ~ Day)+ -->
<!--   scale_color_brewer(type = "div", palette = 5, direction = -1, name = "Parental Temp") -->
<!-- ``` -->

<!-- ```{r fig.width=9, fig.height=4} -->
<!-- F1_epr_mean = aggregate(F1_epr$Total, by = list(F1_epr$Month, F1_epr$Parental_temp, F1_epr$Parental_treatment, F1_epr$Offspring_temp, F1_epr$Day), FUN= mean) -->
<!-- F1_epr_mean = `colnames<-`(F1_epr_mean, c("Month", "Parental_temp", "Parental_treatment", "Offspring_temp","Day", "Total")) -->

<!-- #EPR -->
<!-- F1_epr_se = aggregate(F1_epr$Total, by = list(F1_epr$Month, F1_epr$Parental_temp, F1_epr$Parental_treatment, F1_epr$Offspring_temp, F1_epr$Day), FUN= st.err) -->
<!-- F1_epr_se = `colnames<-`(F1_epr_se, c("Month", "Parental_temp", "Parental_treatment", "Offspring_temp","Day", "SE")) -->

<!-- F1_epr_summarized = cbind(F1_epr_mean, F1_epr_se$SE) -->
<!-- F1_epr_summarized$Month = factor(F1_epr_summarized$Month, levels = c("June", "August", "November")) -->

<!-- F1_total = ggplot(F1_epr_summarized, aes(x = Offspring_temp, y = Total, colour = as.factor(Parental_temp), group = Parental_treatment)) + -->
<!--   geom_errorbar(size=0.6, aes(ymin=(Total - F1_epr_se$SE), ymax=(Total + F1_epr_se$SE)), width=.8) + -->
<!--   geom_line(size = 1) + geom_point(size = 1.5) +  -->
<!--   theme_bw(base_size = 12) + facet_grid(Month ~ Day)+ ggtitle("EPR") +  -->
<!--   scale_color_brewer(type = "div", palette = 5, direction = -1, name = "Parental Temp") -->

<!-- #Hatching -->
<!-- F1_hs_mean = aggregate(F1_epr$Success, by = list(F1_epr$Month, F1_epr$Parental_temp, F1_epr$Parental_treatment, F1_epr$Offspring_temp, F1_epr$Day), FUN= mean) -->
<!-- F1_hs_mean = `colnames<-`(F1_hs_mean, c("Month", "Parental_temp", "Parental_treatment", "Offspring_temp","Day", "Success")) -->

<!-- F1_hs_se = aggregate(F1_epr$Success, by = list(F1_epr$Month, F1_epr$Parental_temp, F1_epr$Parental_treatment, F1_epr$Offspring_temp, F1_epr$Day), FUN= st.err) -->
<!-- F1_hs_se = `colnames<-`(F1_hs_se, c("Month", "Parental_temp", "Parental_treatment", "Offspring_temp","Day", "SE")) -->

<!-- F1_hs_summarized = cbind(F1_hs_mean, F1_hs_se$SE) -->
<!-- F1_hs_summarized$Month = factor(F1_hs_summarized$Month, levels = c("June", "August", "November")) -->

<!-- F1_hs = ggplot(F1_hs_summarized, aes(x = Offspring_temp, y = Success, colour = as.factor(Parental_temp), group = Parental_treatment)) + -->
<!--   geom_errorbar(size=0.6, aes(ymin=(Success - F1_hs_se$SE), ymax=(Success + F1_hs_se$SE)), width=.8) + -->
<!--   geom_line(size = 1) + geom_point(size = 1.5) +  -->
<!--   theme_bw(base_size = 12) + facet_grid(Month ~ Day)+ ggtitle("HS") +  -->
<!--   scale_color_brewer(type = "div", palette = 5, direction = -1, name = "Parental Temp") -->

<!-- #RF -->
<!-- F1_hat_mean = aggregate(F1_epr$Hatched, by = list(F1_epr$Month, F1_epr$Parental_temp, F1_epr$Parental_treatment, F1_epr$Offspring_temp, F1_epr$Day), FUN= mean) -->
<!-- F1_hat_mean = `colnames<-`(F1_hat_mean, c("Month", "Parental_temp", "Parental_treatment", "Offspring_temp","Day", "Hatched")) -->

<!-- F1_hat_se = aggregate(F1_epr$Hatched, by = list(F1_epr$Month, F1_epr$Parental_temp, F1_epr$Parental_treatment, F1_epr$Offspring_temp, F1_epr$Day), FUN= st.err) -->
<!-- F1_hat_se = `colnames<-`(F1_hat_se, c("Month", "Parental_temp", "Parental_treatment", "Offspring_temp","Day", "SE")) -->

<!-- F1_hat_summarized = cbind(F1_hat_mean, F1_hat_se$SE) -->
<!-- F1_hat_summarized$Month = factor(F1_hat_summarized$Month, levels = c("June", "August", "November")) -->

<!-- F1_rf = ggplot(F1_hat_summarized, aes(x = Offspring_temp, y = Hatched, colour = as.factor(Parental_temp), group = Parental_treatment)) + -->
<!--   geom_errorbar(size=0.6, aes(ymin=(Hatched - F1_hat_se$SE), ymax=(Hatched + F1_hat_se$SE)), width=.8) + -->
<!--   geom_line(size = 1) + geom_point(size = 1.5) +  -->
<!--   theme_bw(base_size = 12) + facet_grid(Month ~ Day)+ -->
<!--   xlab("Offspring Temperature") + -->
<!--   ylab("Relative Fecundity") + ggtitle("RF") +  -->
<!--   scale_color_brewer(type = "div", palette = 5, direction = -1, name = "Parental Temp") -->

<!-- a = ggplot() + theme_pubclean() -->
<!-- ggarrange(F1_total, a, F1_hs, a, F1_rf, ncol = 5, nrow = 1, widths = c(1,0.09,1,0.09,1), common.legend = T, legend = "bottom") -->


<!-- ``` -->


<!-- The same data are shown below, but with short- and long-duration heatwave groups overlaid on top of each other so as to easier compare between short- and long-duration heat wave events. The two "axes" of comparisons for this figure are between lines with the same line type but different colors (between control and heatwave), and between the lines with the same colors but different line types (between short and long parental heatwave exposure).  -->

<!-- ```{r fig.width=6} -->
<!-- F1_bs_sum = ggplot(F1_fbs_summarized, aes(x = Offspring_temp, y = Size, colour = as.factor(Parental_temp), linetype = Duration)) + -->
<!--   geom_errorbar(size=.6, linetype = "solid", aes(ymin=(Size - F1_fbs_se$SE), ymax=(Size + F1_fbs_se$SE)), width=.5) + -->
<!--   geom_line(size = 1) + geom_point(size = 1.5) +  -->
<!--   theme_bw(base_size = 12) + facet_grid(Month ~ .)+ -->
<!--   xlab("Offspring Temperature") + -->
<!--   ylab("Body Size (mm)") + ggtitle("Body Size") +  -->
<!--   scale_color_brewer(type = "div", palette = 5, direction = -1,  -->
<!--                      name = "Parental\nTemperature") + -->
<!--   scale_x_continuous(breaks = c(12,14,16,18,20,22,24,26,28)) -->

<!-- F1_hat_summarized$Duration = F1_hat_summarized$Day -->
<!-- F1_hat_summarized$Duration[F1_hat_summarized$Duration == "1_to_3"] = "Short" -->
<!-- F1_hat_summarized$Duration[F1_hat_summarized$Duration == "5_to_7"] = "Long" -->
<!-- F1_hat_summarized$Duration = factor(F1_hat_summarized$Duration, levels = c("Short","Long")) -->

<!-- F1_rf_sum = ggplot(F1_hat_summarized, aes(x = Offspring_temp, y = Hatched, colour = as.factor(Parental_temp), linetype = Duration)) + -->
<!--   geom_errorbar(size=0.6, linetype = "solid", aes(ymin=(Hatched - F1_hat_se$SE), ymax=(Hatched + F1_hat_se$SE)), width=.5) + -->
<!--   geom_line(size = 1) + geom_point(size = 1.5) +  -->
<!--   theme_bw(base_size = 12) + facet_grid(Month ~ .)+ -->
<!--   xlab("Offspring Temperature") + -->
<!--   ylab("Relative Fecundity") + ggtitle("RF") +  -->
<!--   scale_color_brewer(type = "div", palette = 5, direction = -1, name = "Parental Temp") -->

<!-- ggarrange(F1_bs_sum, a, F1_rf_sum, ncol = 3, nrow = 1, widths = c(1,0.1,1), common.legend = T, legend = "bottom") -->
<!-- ``` -->
